<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Usage Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .date-filter {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .stat-card .label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-card .change {
            color: #66bb6a;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .stat-card .change.negative {
            color: #ef5350;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-container h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container canvas {
            max-height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        
        .error {
            background: #ff5252;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .emoji {
            font-size: 24px;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        
        tr:hover {
            background: #fafafa;
        }
        
        .cost {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #4caf50;
        }
        
        .sentiment {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .sentiment.positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .sentiment.neutral {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .sentiment.negative {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Discord Bot Usage Dashboard</h1>
            <div class="subtitle">Real-time analytics for AI token usage and costs</div>
            <div class="date-filter">
                <label>Time Range:</label>
                <select id="dateRange" onchange="updateDashboard()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Messages</div>
                <div class="value" id="totalMessages">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Tokens</div>
                <div class="value" id="totalTokens">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Cost</div>
                <div class="value" id="totalCost">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Avg Cost/Message</div>
                <div class="value" id="avgCost">-</div>
            </div>
        </div>
        
        <div class="chart-container full-width">
            <h2><span class="emoji">üìà</span> Daily Usage Trend</h2>
            <canvas id="dailyChart"></canvas>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h2><span class="emoji">ü§ñ</span> Usage by Model</h2>
                <canvas id="modelChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2><span class="emoji">üìã</span> Support Status Distribution</h2>
                <canvas id="statusChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2><span class="emoji">üé≠</span> Customer Tone</h2>
                <canvas id="toneChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2><span class="emoji">üö®</span> Priority Levels</h2>
                <canvas id="priorityChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container full-width">
            <h2><span class="emoji">‚è∞</span> Hourly Activity Pattern</h2>
            <canvas id="hourlyChart"></canvas>
        </div>
        
        <div class="table-container">
            <h2><span class="emoji">üí¨</span> Top Channels by Cost</h2>
            <table id="channelsTable">
                <thead>
                    <tr>
                        <th>Channel</th>
                        <th>Server</th>
                        <th>Messages</th>
                        <th>Total Cost</th>
                        <th>Avg Sentiment</th>
                    </tr>
                </thead>
                <tbody id="channelsTableBody">
                    <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let charts = {};
        
        async function fetchData(endpoint, params = {}) {
            const queryString = new URLSearchParams(params).toString();
            const response = await fetch(`/api/stats/${endpoint}?${queryString}`);
            return response.json();
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 6
            }).format(value || 0);
        }
        
        function formatNumber(value) {
            return new Intl.NumberFormat('en-US').format(value || 0);
        }
        
        async function updateOverallStats(days) {
            const stats = await fetchData('overall', { days });
            
            document.getElementById('totalMessages').textContent = formatNumber(stats.total_messages);
            document.getElementById('totalTokens').textContent = formatNumber(Math.round(stats.total_tokens));
            document.getElementById('totalCost').textContent = formatCurrency(stats.total_cost);
            document.getElementById('avgCost').textContent = formatCurrency(stats.avg_cost_per_message);
        }
        
        async function updateDailyChart(days) {
            const data = await fetchData('daily', { days });
            
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (charts.daily) {
                charts.daily.destroy();
            }
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Messages',
                            data: data.map(d => d.message_count),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Cost ($)',
                            data: data.map(d => d.total_cost),
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Messages'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }
        
        async function updateModelChart(days) {
            const data = await fetchData('models', { days });
            
            const ctx = document.getElementById('modelChart').getContext('2d');
            
            if (charts.model) {
                charts.model.destroy();
            }
            
            charts.model = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.model),
                    datasets: [{
                        data: data.map(d => d.total_cost),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function updateStatusChart(days) {
            const data = await fetchData('support-status', { days });
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            const colors = {
                'help_request': '#4caf50',
                'bug_report': '#f44336',
                'feature_request': '#2196f3',
                'complaint': '#ff9800',
                'feedback': '#9c27b0',
                'question': '#00bcd4',
                'documentation_issue': '#795548',
                'urgent_issue': '#e91e63',
                'general_discussion': '#607d8b',
                'resolved': '#8bc34a',
                'other': '#9e9e9e'
            };
            
            charts.status = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.support_status || 'Unknown'),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: data.map(d => colors[d.support_status] || '#9e9e9e')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        async function updateToneChart(days) {
            const data = await fetchData('tone', { days });
            
            const ctx = document.getElementById('toneChart').getContext('2d');
            
            if (charts.tone) {
                charts.tone.destroy();
            }
            
            const colors = {
                'happy': '#4caf50',
                'neutral': '#2196f3',
                'frustrated': '#ff9800',
                'angry': '#f44336',
                'confused': '#9c27b0',
                'grateful': '#8bc34a',
                'urgent': '#e91e63',
                'professional': '#607d8b'
            };
            
            charts.tone = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: data.map(d => d.tone || 'Unknown'),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: data.map(d => colors[d.tone] || '#9e9e9e')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function updatePriorityChart(days) {
            const data = await fetchData('priority', { days });
            
            const ctx = document.getElementById('priorityChart').getContext('2d');
            
            if (charts.priority) {
                charts.priority.destroy();
            }
            
            const colors = {
                'critical': '#f44336',
                'high': '#ff9800',
                'medium': '#2196f3',
                'low': '#4caf50'
            };
            
            charts.priority = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.priority || 'Unknown'),
                    datasets: [{
                        data: data.map(d => d.count),
                        backgroundColor: data.map(d => colors[d.priority] || '#9e9e9e')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        async function updateHourlyChart(days) {
            const data = await fetchData('hourly', { days: Math.min(days, 7) });
            
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            // Fill in missing hours
            const hourlyData = Array.from({ length: 24 }, (_, i) => {
                const hourData = data.find(d => d.hour === i);
                return {
                    hour: i,
                    message_count: hourData?.message_count || 0,
                    avg_cost: hourData?.avg_cost || 0
                };
            });
            
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourlyData.map(d => `${d.hour}:00`),
                    datasets: [{
                        label: 'Messages',
                        data: hourlyData.map(d => d.message_count),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        async function updateChannelsTable(days) {
            const data = await fetchData('channels', { days, limit: 10 });
            
            const tbody = document.getElementById('channelsTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((channel, index) => {
                const sentimentClass = channel.avg_sentiment > 0.3 ? 'positive' : 
                                       channel.avg_sentiment < -0.3 ? 'negative' : 'neutral';
                const sentimentEmoji = channel.avg_sentiment > 0.3 ? 'üòä' : 
                                       channel.avg_sentiment < -0.3 ? 'üòî' : 'üòê';
                
                return `
                    <tr>
                        <td><strong>#${channel.channel_name}</strong></td>
                        <td>${channel.server_name}</td>
                        <td>${formatNumber(channel.message_count)}</td>
                        <td class="cost">${formatCurrency(channel.total_cost)}</td>
                        <td>
                            <span class="sentiment ${sentimentClass}">
                                ${sentimentEmoji} ${(channel.avg_sentiment || 0).toFixed(2)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function updateDashboard() {
            const days = document.getElementById('dateRange').value;
            
            try {
                await Promise.all([
                    updateOverallStats(days),
                    updateDailyChart(days),
                    updateModelChart(days),
                    updateStatusChart(days),
                    updateToneChart(days),
                    updatePriorityChart(days),
                    updateHourlyChart(days),
                    updateChannelsTable(days)
                ]);
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        // Initialize dashboard on load
        window.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
            
            // Auto-refresh every 30 seconds
            setInterval(updateDashboard, 30000);
        });
    </script>
</body>
</html>
